// Generated by CoffeeScript 1.3.3
(function() {

  define(function(require, exports, module) {
    var DIVIDER_POSITION, MENU_ENTRY_POSITION, PANEL_POSITION, commands, ext, filelist, fs, ide, markup, menus, noderunner, panels;
    ide = require('core/ide');
    ext = require('core/ext');
    menus = require('ext/menus/menus');
    noderunner = require('ext/noderunner/noderunner');
    commands = require('ext/commands/commands');
    fs = require('ext/filesystem/filesystem');
    panels = require('ext/panels/panels');
    markup = require('text!ext/jasmine/jasmine.xml');
    filelist = require('ext/filelist/filelist');
    DIVIDER_POSITION = 2300;
    MENU_ENTRY_POSITION = 2400;
    PANEL_POSITION = 10000;
    return module.exports = ext.register('ext/jasmine/jasmine', {
      name: 'Jasmine',
      dev: 'Tobias Metzke, Tobias Pfeiffer',
      type: ext.GENERAL,
      alone: true,
      commands: {
        'jasmine': {
          hint: 'Run your tests with jasmine!'
        }
      },
      hotitems: {},
      markup: markup,
      nodes: [],
      hook: function() {
        var _self;
        _self = this;
        this.markupInsertionPoint = colLeft;
        panels.register(this, {
          position: PANEL_POSITION,
          caption: "Jasmine",
          "class": "testing"
        });
        commands.addCommand({
          name: "jasmine",
          hint: "run your specs with jasmine",
          bindKey: {
            mac: "Command-J",
            win: "Ctrl-J"
          },
          exec: function() {
            return _self.jasmine();
          }
        });
        this.nodes.push(menus.addItemByPath("Edit/~", new apf.divider(), DIVIDER_POSITION));
        this.nodes.push(menus.addItemByPath("Edit/Jasmine", new apf.item({
          command: "jasmine"
        }), MENU_ENTRY_POSITION));
        return this.hotitems['jasmine'] = [this.nodes[1]];
      },
      init: function() {
        var _self;
        btnTestRun.$ext.setAttribute("class", "light-dropdown");
        btnTestStop.$ext.setAttribute("class", btnTestStop.$ext.getAttribute("class") + " btnTestStop");
        winTestPanel.$ext.setAttribute("class", winTestPanel.$ext.getAttribute("class") + " testpanel");
        _self = this;
        this.panel = winTestPanel;
        this.nodes.push(winTestPanel, mnuRunSettings, stTestRun);
        ide.dispatchEvent("init.jasmine");
        console.log("after init.jasmine");
        return this.initFilelist();
      },
      initFilelist: function() {
        var _this = this;
        console.log("initFilelist");
        return filelist.getFileList(false, function(data, state) {
          var sanitizedData, specs;
          if (state !== apf.SUCCESS) {
            return;
          }
          console.log("DATAAAAAAAA: " + data);
          sanitizedData = data.replace(/^\./gm, "");
          sanitizedData = sanitizedData.replace(/^\/node_modules\/.*/gm, "");
          console.log("replace: " + sanitizedData);
          specs = sanitizedData.match(/^.*\.spec\.(js|coffee)$/gm);
          console.log("SPEEEEECCCSSSSS " + specs);
          return _this.addFiles(specs, mdlTests.queryNode("repo[1]"));
        });
      },
      addFiles: function(specs, parent) {
        var xmlFiles;
        console.log("addFiles");
        xmlFiles = "";
        specs.each(function(spec) {
          return xmlFiles += "<file path='" + apf.escapeXML(ide.davPrefix + spec) + "' name='" + apf.escapeXML(spec.split("/").pop()) + "' type='jasmine' />";
        });
        console.log("xmlFiles");
        console.log(xmlFiles);
        return mdlTests.insert("<files>" + xmlFiles + "</files>", {
          insertPoint: parent
        });
      },
      show: function() {
        if ((navbar.current != null) && (navbar.current !== this)) {
          navbar.current.disable();
        } else {
          return;
        }
        panels.initPanel(this);
        return this.enable();
      },
      enable: function() {
        return this.nodes.each(function(item) {
          if (item.enable) {
            return item.enable();
          }
        });
      },
      disable: function() {
        return this.nodes.each(function(item) {
          if (item.disable) {
            return item.disable();
          }
        });
      },
      destroy: function() {
        this.nodes.each(function(item) {
          return item.destroy(true, true);
        });
        this.nodes = [];
        return panels.unregister(this);
      },
      run: function(nodes) {
        var fileNames;
        console.log("noddeesss");
        console.log(nodes);
        fileNames = "(";
        nodes.each(function(node) {
          var name;
          name = node.getAttribute('name');
          name = name.slice(0, name.indexOf('.'));
          return fileNames += name + '|';
        });
        fileNames = fileNames.slice(0, -1) + ')';
        return noderunner.run('node_modules/jasmine-node/lib/jasmine-node/cli.js', ['--coffee', "-m \"" + fileNames + "\.\"", 'spec/'], false);
      },
      jasmine: function() {
        console.log("Jasmine starts to run");
        return noderunner.run('node_modules/jasmine-node/lib/jasmine-node/cli.js', ['--coffee', '-m "(itemStorage|server)\."', 'spec/'], false);
      }
    });
  });

}).call(this);
